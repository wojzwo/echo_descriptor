<!--echo_desc/web/templates/index.html-->
<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Echo Descriptor</title>
  <link rel="stylesheet" href="/static/app.css">
</head>
<body>
  <header class="pageHeader">
    <h1>Echo Descriptor</h1>
    <div class="muted">
      Parametry: widoczne + reszta w “rozwiń”. Settings zapisuje ustawienia do repo
      (<span class="pill">./config/web/parameters_ui.yaml</span>) — bez localStorage.
    </div>
  </header>

  <!-- Tabs -->
  <nav class="tabs section" aria-label="Nawigacja">
    <button type="button"
            class="tabbtn {% if active_tab == 'params' %}active{% endif %}"
            data-tab="tab-params">Parametry</button>

    <button type="button"
            class="tabbtn {% if active_tab == 'template' %}active{% endif %}"
            data-tab="tab-template">Szablon</button>

    <button type="button"
            class="tabbtn {% if active_tab == 'settings' %}active{% endif %}"
            data-tab="tab-settings">Settings</button>
  </nav>

  <!-- =========================
       FORM A: GENERATE REPORT
       ========================= -->
  <form id="generateForm" method="post" action="/generate" class="section">
    <div class="twoCols section">
      <div class="card">
        <h3>Dane pacjenta</h3>
        <div class="grid">
          <div>
            <label for="weight_kg">Masa [kg]</label>
            <input id="weight_kg" name="weight_kg" type="number" step="0.01" required value="{{ weight_kg }}" />
          </div>
          <div>
            <label for="height_cm">Wzrost [cm]</label>
            <input id="height_cm" name="height_cm" type="number" step="0.1" required value="{{ height_cm }}" />
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Szablon raportu</h3>
        <div class="grid">
          <div>
            <label for="templateSelect">Wybierz raport</label>
            <select name="template_id" id="templateSelect">
              {% for t in templates_list %}
                <option value="{{ t.id }}" {% if t.id == selected_template_id %}selected{% endif %}>
                  {{ t.title }} ({{ t.id }})
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="muted" style="margin-top:8px;">
          W tabie “Szablon” możesz edytować paragrafy i składy raportów.
        </div>
      </div>
    </div>

    <!-- TAB: PARAMS -->
    <section id="tab-params" class="panel {% if active_tab == 'params' %}active{% endif %}">
      <h3>Parametry</h3>
      <div class="muted">Puste pola = brak parametru. Widoczność/kolejność ustawiasz w Settings.</div>

      <div class="section">
        <div class="card">
          <h4 class="cardTitle">Widoczne</h4>

          <div class="paramsGrid" id="paramsVisible">
            {% for it in params_visible %}
              {% set pid = "param__" ~ it.name %}
              <div class="paramCard" data-param="{{ it.name }}">
                <label class="paramKey" for="{{ pid }}">{{ it.label }}</label>
                {% if it.description %}
                  <div class="paramDesc">{{ it.description }}</div>
                {% endif %}
                <input
                  id="{{ pid }}"
                  name="{{ it.name }}"
                  type="number"
                  step="0.0001"
                  value="{{ raw_vals.get(it.name, '') }}"
                />
              </div>
            {% endfor %}
          </div>

          {% if params_hidden|length > 0 %}
          <div class="section">
            <details>
              <summary>Pozostałe (ukryte) — rozwiń</summary>

              <div class="paramsGrid" id="paramsHidden" style="margin-top:10px;">
                {% for it in params_hidden %}
                  {% set pid = "param__" ~ it.name %}
                  <div class="paramCard" data-param="{{ it.name }}">
                    <label class="paramKey" for="{{ pid }}">{{ it.label }}</label>
                    {% if it.description %}
                      <div class="paramDesc">{{ it.description }}</div>
                    {% endif %}
                    <input
                      id="{{ pid }}"
                      name="{{ it.name }}"
                      type="number"
                      step="0.0001"
                      value="{{ raw_vals.get(it.name, '') }}"
                    />
                  </div>
                {% endfor %}
              </div>
            </details>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="section">
        <button type="submit" class="primaryBtn">Generuj</button>
      </div>

      {% if error %}
        <div class="err section">{{ error }}</div>
      {% endif %}

      {% if report %}
        <h2 class="section">Wynik</h2>
        <pre>{{ report }}</pre>
      {% endif %}
    </section>

    <!-- TAB: TEMPLATE (EDITOR) -->
    <section id="tab-template" class="panel {% if active_tab == 'template' %}active{% endif %}">
      <h3>Template Editor</h3>
      <div class="muted">
        Edytujesz bazę paragrafów oraz raporty (kolejność paragrafów ma znaczenie).
      </div>

      <!-- sub-tabs -->
      <div class="subtabs section" role="tablist" aria-label="Template editor">
        <button
          type="button"
          class="subtabbtn active"
          data-subtab="sub-paragraphs"
          role="tab"
          aria-controls="sub-paragraphs"
          aria-selected="true">
          Paragraphs
        </button>

        <button
          type="button"
          class="subtabbtn"
          data-subtab="sub-reports"
          role="tab"
          aria-controls="sub-reports"
          aria-selected="false">
          Reports
        </button>
      </div>

      <!-- PARAGRAPHS -->
      <div id="sub-paragraphs" class="subpanel active" role="tabpanel" aria-label="Paragraphs">
        <div class="section inlineBtns" style="align-items:center;">
          <button type="button" id="btnParAdd">+ Nowy paragraf</button>
          <button type="button" class="primaryBtn" id="btnTplSave1">Zapisz do YAML</button>
          <span class="muted" id="tplDirty1" style="display:none;">Masz niezapisane zmiany.</span>

          <div style="flex:1;"></div>

          <div style="min-width:260px;">
            <input type="search" id="tplParSearch" placeholder="Szukaj paragrafów…" />
          </div>
        </div>

        <div class="card section">
          <div class="tplList" id="paragraphList"></div>
        </div>
      </div>

      <!-- REPORTS -->
      <div id="sub-reports" class="subpanel" role="tabpanel" aria-label="Reports">
        <div class="section inlineBtns" style="align-items:center;">
          <button type="button" id="btnRepAdd">+ Nowy raport</button>
          <button type="button" class="primaryBtn" id="btnTplSave2">Zapisz do YAML</button>
          <span class="muted" id="tplDirty2" style="display:none;">Masz niezapisane zmiany.</span>

          <div style="flex:1;"></div>

          <div style="min-width:260px;">
            <input type="search" id="tplRepSearch" placeholder="Szukaj raportów…" />
          </div>
        </div>

        <div class="card section">
          <div class="tplList" id="reportList"></div>
        </div>
      </div>

      <div class="section muted">
        Backend zapisuje do:
        <span class="pill">./config/reports/paragraphs.yaml</span>
        <span class="pill">./config/reports/reports.yaml</span>
      </div>
    </section>
  </form>

  <!-- TAB: SETTINGS -->
  <section id="tab-settings" class="panel {% if active_tab == 'settings' %}active{% endif %}">
    <h3>Settings: widoczność i kolejność parametrów</h3>
    <div class="muted">
      To jest ustawienie UI (webgui). Zapis idzie do repo:
      <span class="pill">./config/web/parameters_ui.yaml</span>
    </div>

    <form id="settingsForm" method="post" action="/settings/save" class="section">
      <div class="section settingsControls">
        <button type="submit" class="primaryBtn">Zapisz</button>
        <button type="button" id="btnSelectAll">Pokaż wszystkie</button>
        <button type="button" id="btnHideAll">Ukryj wszystkie</button>
        <button type="button" id="btnResetOrder">Reset order (registry)</button>
        <button type="button" id="btnExport">Export YAML (podgląd)</button>
      </div>

      <div class="section tableWrap">
        <table class="settingsTable" id="settingsTable">
          <thead>
            <tr>
              <th style="width:42px;"></th>
              <th style="width:90px;">Pokaż</th>
              <th style="width:120px;">Order</th>
              <th>Parametr</th>
            </tr>
          </thead>
          <tbody id="settingsBody">
            {% for it in param_items_all %}
              {% set st = param_ui.get(it.name, {}) %}
              {% set enabled = st.get('enabled', True) %}
              {% set order = st.get('order', loop.index * 10) %}
              <tr data-param="{{ it.name }}" draggable="true">
                <td class="dragCell"><span class="dragHandle" title="Przeciągnij">☰</span></td>
                <td>
                  <input type="checkbox" class="uiEnabled" name="enabled__{{ it.name }}" {% if enabled %}checked{% endif %}/>
                </td>
                <td>
                  <input class="orderInput uiOrder" type="number" name="order__{{ it.name }}" value="{{ order }}"/>
                </td>
                <td>
                  <strong>{{ it.name }}</strong>
                  {% if it.description %}
                    <div class="muted">{{ it.description }}</div>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="section">
        <h4 style="margin:0 0 8px 0;">Podgląd YAML</h4>
        <textarea id="exportBox" readonly></textarea>
      </div>
    </form>
  </section>

  <script id="tplData" type="application/json">{{ templates_json | safe }}</script>

  <script src="/static/app.js" defer></script>
  <script src="/static/tabs.js" defer></script>
  <script src="/static/settings_ui.js" defer></script>

  <script src="/static/tpl_model.js" defer></script>
  <script src="/static/tpl_render.js" defer></script>
  <script src="/static/templates_ui.js" defer></script>
</body>
</html>
